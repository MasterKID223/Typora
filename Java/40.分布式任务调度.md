## 分布式任务调度（XXL-JOB）

参考：[第3章媒资管理模块v3.1.docx 7.2.2 XXL-JOB介绍]

xxl-job官网：[[https://www.xuxueli.com/xxl-job/](https://www.xuxueli.com/xxl-job/)]

### 使用docker在虚拟机中部署xxl-job

XXL-JOB 是一个流行的 Java 分布式任务调度平台。使用 Docker 在虚拟机中启动 XXL-JOB 服务可以简化部署和配置过程。以下是如何使用 Docker 在虚拟机上部署 XXL-JOB 服务的步骤：

1. **安装 Docker**:
   如果你的虚拟机还没有安装 Docker，请先进行安装。根据你的操作系统，可以参考 Docker 官方文档来安装。

2. **获取 XXL-JOB 的 Docker 镜像**:
   你可以从 Docker Hub 上获取 XXL-JOB 的官方或社区提供的 Docker 镜像。例如：
   
   ```bash
   docker pull xuxueli/xxl-job-admin:2.3.1
   ```
   
3. **启动 XXL-JOB 服务**:
   以 XXL-JOB Admin 为例，使用以下命令启动：
   
   ```bash
   sudo docker run -d --name xxl-job-admin -p 8088:8080 \
   -e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.56.128:3306/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai&useSSL=false --spring.datasource.username=xczx --spring.datasource.password=123456 --xxl.job.accessToken=mkid" \
   xuxueli/xxl-job-admin:2.3.1
   ```
   
   官网：
   
   ```bash
   sudo docker run -p 8080:8080 -v /tmp:/data/applogs --name xxl-job-admin  -d xuxueli/xxl-job-admin:2.3.1
   /**
   * 如需自定义 mysql 等配置，可通过 "-e PARAMS" 指定，参数格式 PARAMS="--key=value  --key2=value2" ；
   * 配置项参考文件：/xxl-job/xxl-job-admin/src/main/resources/application.properties
   * 如需自定义 JVM内存参数 等配置，可通过 "-e JAVA_OPTS" 指定，参数格式 JAVA_OPTS="-Xmx512m" ；
   */
   sudo docker run -e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.56.128:3306/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai --spring.datasource.username=xczx --spring.datasource.password=123456" -p 8080:8080 -v /tmp:/data/applogs --name xxl-job-admin  -d xuxueli/xxl-job-admin:2.3.1
   ```
   
   **注意**：
   
   - `[DB_HOST]`, `[DB_PORT]`, `[DB_USER]`, 和 `[DB_PASS]` 需要替换为你的数据库实际的信息。
   - 该命令假设你已经有一个 MySQL 数据库，并且数据库中已经初始化了 XXL-JOB 所需的数据表。
   - 如果你还没有数据库，你可能需要先部署一个 MySQL 容器或者使用其他数据库并进行相应的配置。
   
4. **访问 XXL-JOB Admin 控制台**:
   在浏览器中，通过虚拟机的 IP 和端口 8088 来访问 XXL-JOB Admin 的控制台。

   访问：http://192.168.56.128:8088/xxl-job-admin/
   
   账号和密码：admin/123456
   
5. **配置执行器 (Executor)**:
   在实际的生产环境中，你可能还需要配置 XXL-JOB 的执行器来执行实际的任务。你可以根据 XXL-JOB 的官方文档来部署和配置执行器。

6. **持久化数据**:
   为了避免数据丢失，你应该考虑为数据库和 XXL-JOB 的配置进行数据持久化。这通常可以通过 Docker 的 volume 功能来实现。

以上是一个简化的部署步骤，你可能需要根据实际的生产环境和需求进行一些额外的配置和优化。

### docker和mysql在同一台机器上

当 Docker 容器和 MySQL 数据库都在同一台物理机器上运行时，连接到 MySQL 时有一个特殊的注意事项：你不能使用 IP 地址 `localhost` 或 `127.0.0.1`，因为在容器内，这将指向容器本身，而不是宿主机。

为了从容器内部访问宿主机上的服务，你有以下几种选择：

1. **使用宿主机的外部 IP 地址**：这是最简单的方式，只需将宿主机的 IP 地址（例如 `192.168.56.128`）用于连接字符串。

2. **使用特殊的 DNS 名称**（仅限于 Docker for Windows 或 Docker for Mac）：`host.docker.internal` 可以解析为宿主机的 IP 地址。

3. **使用默认网关**：在 Docker 容器内，你可以使用默认网关的 IP 地址来访问宿主机。但这种方式稍显复杂，不推荐给初学者。

针对第一种方法，你可以使用以下命令来启动 XXL-JOB：

```bash
docker run -d --name xxl-job-admin -p 8080:8080 \
-e PARAMS="--spring.datasource.url=jdbc:mysql://[HOST_MACHINE_IP]:3306/xxl-job?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull --spring.datasource.username=[DB_USER] --spring.datasource.password=[DB_PASS]" \
xuxueli/xxl-job-admin:[TAG]
```

请将 `[HOST_MACHINE_IP]` 替换为你的物理机的 IP 地址，`[DB_USER]` 和 `[DB_PASS]` 分别替换为你的数据库用户名和密码，以及 `[TAG]` 替换为你想要使用的具体版本标签。

请注意，与远程数据库连接时的建议相同，你需要确保 MySQL 已配置为允许来自该 IP 地址的连接，同时要确保宿主机的防火墙不会阻止这些连接。

### 使用IDEA启动

