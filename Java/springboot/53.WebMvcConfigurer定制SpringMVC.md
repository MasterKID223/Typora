### WebMvcConfigurer类

参考pdf 5.6节。

### 页面跳转控制器

访问url可以直接跳转到index.html页面，不需要经过Controller。

```java
/**
 * SpringMVC配置：使用JavaConfig的方式配置SpringMVC，代替原来的xml配置文件
 */
@Configuration
public class MvcSettings implements WebMvcConfigurer {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/welcome").setViewName("index");
    }
}
```

### 自定义数据格式

WebMvcConfigurer中的Formatter接口。

Bean对象：

```java
@Data
public class DeviceInfo {

    private String item1;
    private String item2;
    private String item3;
    private String item4;
    private String item5;
}
```

首先重写数据格式化方法

```java
public class DeviceFormatter implements Formatter<DeviceInfo> {

    @Override
    public DeviceInfo parse(String text, Locale locale) throws ParseException {
        DeviceInfo deviceInfo = null;
        if (StringUtils.hasLength(text)) {
            String[] textArr = text.split(";");
            deviceInfo = new DeviceInfo();
            deviceInfo.setItem1(textArr[0]);
            deviceInfo.setItem2(textArr[1]);
            deviceInfo.setItem3(textArr[2]);
            deviceInfo.setItem4(textArr[3]);
            deviceInfo.setItem5(textArr[4]);
        }
        return deviceInfo;
    }

    // 将DeviceInfo转换成String
    @Override
    public String print(DeviceInfo object, Locale locale) {
        StringJoiner joiner = new StringJoiner("#");
        joiner.add(object.getItem1()).add(object.getItem2());
        return joiner.toString();
    }
}
```

控制器使用`@RequestParam("device")`接收参数，解析过程中使用上面重写好的方法。

```java
@RestController
//@Controller
public class DeviceController {

    @PostMapping("/device/add")
    public String addDevice(@RequestParam("device") DeviceInfo info) {
        return "接收到的设备数据：" + info.toString();
    }
}
```

在配置类中，注册自己定义好的Formatter，否则不起作用。

```java
/**
 * SpringMVC配置：使用JavaConfig的方式配置SpringMVC，代替原来的xml配置文件
 */
@Configuration
public class MvcSettings implements WebMvcConfigurer {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/welcome").setViewName("index");
    }

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addFormatter(new DeviceFormatter());
    }
}
```

### 自定义拦截器

在Dispatch之后Controller之前。

```java
@RestController
public class ArticleController {

    @PostMapping("/article/add")
    public String add() {
        return "添加文章";
    }

    @PostMapping("/article/edit")
    public String edit() {
        return "编辑文章";
    }

    @GetMapping("/article/query")
    public String remove() {
        return "查询文章";
    }

}
```

```java
public class AuthInterceptor implements HandlerInterceptor {

    private final String COMMON_USER = "lzh";

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        System.out.println("=====AuthInterceptor 权限拦截器=====");
        //获取登录的用户
        String user = request.getParameter("user");
        // 获取操作URL
        String url = request.getRequestURI();

        if (COMMON_USER.equals(user) && (url.startsWith("/article/add") || url.startsWith("/article/edit"))) {
            return false;
        }
        return true;
    }
}
```

```java
/**
 * SpringMVC配置：使用JavaConfig的方式配置SpringMVC，代替原来的xml配置文件
 */
@Configuration
public class MvcSettings implements WebMvcConfigurer {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/welcome").setViewName("index");
    }

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addFormatter(new DeviceFormatter());
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        AuthInterceptor authInterceptor = new AuthInterceptor();
        registry.addInterceptor(authInterceptor)
                .addPathPatterns("/article/*")  // 拦截 article 开始的所有请求
                .excludePathPatterns("/article/query");  // 排除/article/query 请求
    }
}
```

测试：

```http
###
POST http://localhost:8080/article/add
Content-Type: application/x-www-form-urlencoded

user=lzh

###
POST http://localhost:8080/article/edit
Content-Type: application/x-www-form-urlencoded

user=lzh

###
GET http://localhost:8080/article/query?user=lzh
```

### 多个拦截器

```java
public class AuthInterceptor implements HandlerInterceptor {

    private final String COMMON_USER = "lzh";

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        System.out.println("=====AuthInterceptor 权限拦截器=====");
        //获取登录的用户
        String user = request.getParameter("user");
        // 获取操作URL
        String url = request.getRequestURI();

        if (COMMON_USER.equals(user) && (url.startsWith("/article/add") || url.startsWith("/article/edit"))) {
            return true;
        }
        return false;
    }
}
```

```java
public class LoginInterceptor implements HandlerInterceptor {

    private List<String> permitUser = new ArrayList<>();

    public LoginInterceptor() {
        permitUser = Arrays.asList("lzh", "lzh2", "lzh3");
    }

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        System.out.println("=====LoginInterceptor 登录拦截器=====");
        String user = request.getParameter("user");
        if (StringUtils.hasText(user) && permitUser.contains(user)) {
            return true;
        }
        return false;
    }
}
```

```java
/**
 * SpringMVC配置：使用JavaConfig的方式配置SpringMVC，代替原来的xml配置文件
 */
@Configuration
public class MvcSettings implements WebMvcConfigurer {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/welcome").setViewName("index");
    }

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addFormatter(new DeviceFormatter());
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        AuthInterceptor authInterceptor = new AuthInterceptor();
        registry.addInterceptor(authInterceptor)
                .order(2)
                .addPathPatterns("/article/*")  // 拦截 article 开始的所有请求
                .excludePathPatterns("/article/query");  // 排除/article/query 请求

        registry.addInterceptor(new LoginInterceptor())
                .order(1)
                .addPathPatterns("/**");
    }
}
```