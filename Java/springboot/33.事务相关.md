### 事务概述

参考springboot3 pdf教程里的内容。

### 准备事务测试环境

配置数据库连接：application.properties

```properties
# 配置数据源
# 默认连接池，可以修改为其他的，比如Tomcat，DBCP
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/blog?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=false
spring.datasource.username=root
spring.datasource.password=123456
# 连接池的一些配置
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.connection-test-query=select 1

# 设置执行数据库脚本 always:总是执行 never:不执行脚本了
spring.sql.init.mode=never

# 驼峰，下划线命名
mybatis.configuration.map-underscore-to-camel-case=true
# 开启Mybatis日志
mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

Mapper：

注意配置文件中的驼峰-下划线配置只对Select生效，Insert还是要自己对应数据库字段名和类的属性名。



```java
public interface ArticleMapper {

    @Select("""
        select * from article where id=#{id}
            """)
    ArticlePO selectTest(Integer id);

    @Insert("""
        insert into article(user_id,title,summary,read_count,create_time,update_time) \
            values(#{userId},#{title},#{summary},#{readCount},#{createTime},#{updateTime})
            """)
    @Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")  // 读取自动增长的id值，赋值给参数里的ArticlePO对象的id属性
    int insertArticle(ArticlePO article);

    @Insert("""
        insert into article_detail(article_id,content) \
            values(#{articleId},#{content})
            """)
    int insertArticleContent(ArticleDetailPO articleDetail);
}
```

ServiceImpl：

```java
public class ArticleServiceImpl implements ArticleService {

    @Autowired
    private ArticleMapper articleMapper;

    @Override
    public boolean postNewArticle(ArticlePO article, String content) {

        // 新增文章
        int row = articleMapper.insertArticle(article);

        // 新增文章内容
        ArticleDetailPO articleDetailPO = new ArticleDetailPO();
        articleDetailPO.setArticleId(article.getId());
        articleDetailPO.setContent(content);
        int detailRow = articleMapper.insertArticleContent(articleDetailPO);

        return (row + detailRow) == 2 ? true : false;
    }
}
```

测试：

```java
@Autowired
private ArticleService articleService;

@Test
void testAddArticle() {
    ArticlePO articlePO = new ArticlePO();
    articlePO.setUserId(new Random().nextInt(5000));
    articlePO.setTitle("Spring 事务管理");
    articlePO.setSummary("Spring 事务属性，事务实现");
    articlePO.setReadCount(new Random().nextInt(1000));
    articlePO.setCreateTime(LocalDateTime.now());
    articlePO.setUpdateTime(LocalDateTime.now());
    boolean add = articleService.postNewArticle(articlePO, "Spring 统一事务管理。事务管理器管理本地事务");
    System.out.println("是否成功添加：" + add);
}
```

