## nacos基础使用

nacos官网：[[nacos中文官网](https://nacos.io/zh-cn/index.html)]

### nacos下载

按照官网文档里的步骤直接解压github上的压缩包即可。

### 基础使用

#### 启动nacos服务器和关闭

进入解压的bin目录：

启动命令(standalone代表着单机模式运行，非集群模式):

```
startup.cmd -m standalone
```

关闭：

```
shutdown.cmd
```

或者双击shutdown.cmd运行文件。

==下面nacos的基础功能包括：服务注册、服务发现、发布配置、获取配置。下面的例子是通过给nacos服务器发送http请求，实现nacos的功能。curl是在命令行中发送http请求的命令（client url）。==

#### 服务注册

```she
curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&ip=20.18.7.10&port=8080'
```

#### 服务发现

```
curl -X GET 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'
```

#### 发布配置

```
curl -X POST "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&group=test&content=HelloWorld"
```

#### 获取配置

```
curl -X GET "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&group=test"
```

### 心跳机制（健康检查）

Nacos目前支持临时实例使用心跳上报方式维持活性。Nacos客户端会维护一个定时任务，每隔==5==秒发送一次心跳请求，以确保自己处于活跃状态。

Nacos服务端在==15==秒内如果没收到客户端的心跳请求，会将该实例设置为不健康，在==30==秒内没收到心跳，会将这个临时实例摘除。

#### python在flask应用中实现心跳机制（异步）

参考：[[csdn：python实现nacos注册和心跳](https://blog.csdn.net/m0_37892044/article/details/124167874)] [[csdn：python线程怎么停止](https://blog.csdn.net/captain5339/article/details/128360804)]

主要代码：

```python
import time
import requests
from threading import Timer, Event

# nacos心跳机制
def service_beat(event):
    url = f"http://{app.config['NACOS_SERVER_ADDRESS']}/nacos/v1/ns/instance/beat?serviceName={app.config['NACOS_SERVER_NAME']}&ip={app.config['NACOS_CLIENT_IP']}&port={app.config['PORT']}"
    while True:
        if event.is_set():  # flask应用关闭的时候，退出心跳线程
            break
        res = requests.put(url)  # 发送心跳，维持健康状态
        print("已注册服务，执行心跳服务，续期服务响应状态： {}".format(res.status_code))
        time.sleep(5)

if __name__ == '__main__':
    # 把当前应用注册到nacos中
    service_url = service_register(app.config['NACOS_CLIENT_IP'], app.config['PORT'], app.config['NACOS_SERVER_NAME'])
    # 注册到nacos之后，需要自己实现心跳健康检测机制（异步线程实现）
    event = Event()
    heart_beat = Timer(5, service_beat, args=(event, ))  # 5秒以后，异步执行service_beat()方法
    heart_beat.start()
    CORS(app, supports_credentials=True)  # 允许请求携带cookies
    app.run(
        port=app.config['PORT']
    )
    print("心跳线程结束。")
    event.set()
    heart_beat.cancel()
```

