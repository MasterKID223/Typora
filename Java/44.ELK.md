## Elasticsearch

### 安装

参考：[[博客园](https://www.cnblogs.com/baoshu/p/16128127.html)]

在 Docker 中安装 Elasticsearch 和 Kibana 是一个相对简单的过程。以下是基本步骤：

**安装 Elasticsearch**

1. **拉取 Elasticsearch 镜像**:
   使用 Docker 命令拉取最新的 Elasticsearch 镜像：

   ```
   docker pull elasticsearch:7.17.14
   ```

2. **运行 Elasticsearch 容器**:
   使用以下命令启动一个 Elasticsearch 实例：

   ```
   docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" elasticsearch:7.17.14
   ```
   这里 `-d` 表示后台运行，`-p` 映射端口，`-e` 设置环境变量。

   在运行 Elasticsearch 容器时，指定两个端口（9200 和 9300）是因为 Elasticsearch 默认使用这两个端口来处理不同的类型的通信：

   1. **9200 端口**:
      - 这是 Elasticsearch 的 HTTP 服务端口。
      - 它用于 RESTful API 的通信，包括数据的索引、搜索、管理请求等。
      - 通过这个端口，你可以使用 HTTP 客户端（如 curl、Postman 或任何支持 HTTP 的编程语言库）与 Elasticsearch 交互。

   2. **9300 端口**:
      - 这个端口用于 Elasticsearch 节点之间的内部通信。
      - 它主要用于集群内部的数据交换、节点间的状态共享、以及集群协调。
      - 如果你有一个 Elasticsearch 集群，那么节点之间会通过这个端口进行通信。

   在 Docker 容器中映射这两个端口的目的是确保外部访问（例如，来自宿主机或其他容器的请求）可以通过这些端口与容器内部的 Elasticsearch 进行通信。映射 9200 端口允许你从容器外部进行 HTTP 请求，而映射 9300 端口则是为了在需要时支持集群功能。

   如果你只打算使用单节点 Elasticsearch，并且不打算构建集群，那么只映射 9200 端口也是可以的。但是，为了完整性和可能的未来扩展，通常建议映射这两个端口。

3. 访问不受地址限制（没成功）

   - 对于 Elasticsearch，确保 `elasticsearch.yml` 配置文件中的 `network.host` 设置为允许外部访问（例如设置为 `0.0.0.0`）。
   - 对于 Kibana，确保 `kibana.yml` 中的 `server.host` 配置为 `"0.0.0.0"`。

   ```bash
   docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" -e "network.host=0.0.0.0" docker.elastic.co/elasticsearch/elasticsearch:7.10.0
   
   docker run -d --name kibana -p 5601:5601 -e "server.host=0.0.0.0" --link elasticsearch:elasticsearch docker.elastic.co/kibana/kibana:7.10.0
   ```

4. 加配置文件尝试（成功）

   重点是因为加了`--net=host`选项。

   ```bash
   docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
   -d --restart=always \
   -e "discovery.type=single-node" \
   -e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
   -v /home/mkid/mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
   -v /home/mkid/mydata/elasticsearch/data:/usr/share/elasticsearch/data \
   -v /home/mkid/mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \
   -d elasticsearch:7.17.14
   ```

   ```bash
   docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
   -e "discovery.type=single-node" \ 
   -d elasticsearch:7.17.14
   ```

   ==7.17.7版本，因为ik分词器只有这个版本==

   ```bash
   docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
   -d --restart=always \
   -e "discovery.type=single-node" \
   -e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
   -v /home/mkid/mydata/elasticsearch7.17.7/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
   -v /home/mkid/mydata/elasticsearch7.17.7/data:/usr/share/elasticsearch/data \
   -v /home/mkid/mydata/elasticsearch7.17.7/plugins:/usr/share/elasticsearch/plugins \
   -d elasticsearch:7.17.7
   ```

   

5. 启动之后访问不了9200端口

   参考：[[csdn](https://blog.csdn.net/weixin_42410983/article/details/104514035)] [[腾讯云](https://cloud.tencent.com/developer/article/2224223)]

   访问9200端口出现警告：

   ```
   {"type": "server", "timestamp": "2023-11-11T14:45:02,481Z", "level": "WARN", "component": "o.e.b.BootstrapChecks", "cluster.name ": "docker-cluster", "node.name": "db9f84c7907d", "message": "initial heap size [67108864] not equal to maximum heap size [53687 0912]; this can cause resize pauses" }
   {"type": "server", "timestamp": "2023-11-11T14:45:02,481Z", "level": "WARN", "component": "o.e.b.BootstrapChecks", "cluster.name ": "docker-cluster", "node.name": "db9f84c7907d", "message": "max virtual memory areas vm.max_map_count [65530] is too low, incr ease to at least [262144]" }
   ```


6. 为什么加了`--net=host`就可以成功访问

   当您在启动 Docker 容器时使用 `--net=host` 配置并能够成功访问 Elasticsearch 的 9200 端口时，这是因为 `--net=host` 指令使容器使用主机的网络堆栈，而不是使用 Docker 的默认网络模式（通常是桥接模式）。

   这里是具体原因和影响：

   1. **网络隔离**：
      - 在默认的桥接模式下，Docker 为每个容器创建一个隔离的网络环境。这意味着容器有自己的私有网络，其 IP 地址、端口等与主机网络是隔离的。
      - 使用 `--net=host` 时，容器不再有自己独立的网络环境，而是直接使用主机的网络。这就使得容器内的应用程序能够直接使用主机的 IP 地址和端口，不需要进行额外的网络转发或映射。

   2. **端口映射**：
      - 在桥接模式下，访问容器内部服务（例如 Elasticsearch）需要显式地映射容器端口到主机端口（例如 `-p 9200:9200`）。如果未正确映射，主机无法直接访问容器内的服务。
      - 当使用 `--net=host` 时，容器的网络接口与主机完全相同。这就意味着 Elasticsearch 监听的 9200 端口直接绑定到主机的网络接口上，不需要单独的端口映射。

   3. **安全性和隔离**：
      - 使用 `--net=host` 可以简化某些网络配置，但它降低了容器与主机之间的网络隔离，可能会带来安全隐患。在生产环境中，应该谨慎使用这个选项，因为它可能允许容器访问主机网络上的其他服务和资源。

   4. **易用性**：
      - 在某些情况下，尤其是在测试和开发环境中，使用 `--net=host` 可以简化配置，因为您不需要担心端口映射和网络转发的问题。

   总之，当您使用 `--net=host` 时，容器和主机共享相同的网络环境，所以容器中的服务就像直接运行在主机上一样，容易从外部访问。但这种方便性也带来了隔离性和安全性的降低，需要根据实际情况权衡使用。

**安装 Kibana**

1. **拉取 Kibana 镜像**:
   使用 Docker 命令拉取最新的 Kibana 镜像：

   ```bash
   docker pull docker.elastic.co/kibana/kibana:7.17.14
   ```

2. **运行 Kibana 容器**:
   使用以下命令启动一个 Kibana 实例，链接到 Elasticsearch：

   ```bash
   docker run -d --name kibana -p 5601:5601 --link elasticsearch:elasticsearch kibana:7.17.14
   ```
   这里 `-p` 映射端口，`--link` 将 Kibana 连接到 Elasticsearch 容器。

3. 临时运行

   ```bash
   docker run -d --name kibana -p 5601:5601 kibana:7.17.14
   ```

4. 重新运行

   ```bash
   docker run -d --name kibana -p 5601:5601 -v /home/mkid/mydata/kibana/config:/usr/share/kibana/config --link elasticsearch:elasticsearch kibana:7.17.14
   ```

   ==7.17.7版本==

   ```bash
   docker run -d --name kibana -p 5601:5601 -d --restart=always -v /home/mkid/mydata/kibana/config:/usr/share/kibana/config --link elasticsearch:elasticsearch kibana:7.17.7
   ```

**验证安装**

- **访问 Elasticsearch**:
  打开浏览器，访问 `http://192.168.56.128:9200`，应该可以看到 Elasticsearch 的信息。

- **访问 Kibana**:
  打开浏览器，访问 `http://192.168.56.128:5601`，如果安装成功，你应该能看到 Kibana 的界面。

**注意事项**

- 确保 Docker 已正确安装并运行在你的系统上。
- 版本号（如 7.17.14）可以根据需求替换为其他版本。
- 对于生产环境，你可能需要更复杂的配置，例如安全设置、持久化存储和集群配置。

这个过程适用于快速启动和测试 Elasticsearch 与 Kibana，但对于生产部署，可能需要更详细和安全的配置。

### 基本概念

可通过命令：GET /_cat/indices?v 查看所有的索引，通过此命令判断kibana是否正常连接elasticsearch。

索引相当于MySQL中的表，Elasticsearch与MySQL之间概念的对应关系见下表：

![img](./pic/clip_image002.gif)

要使用elasticsearch需要建立索引，Mapping相当于表结构，Mapping创建后其字段不能删除，如果要删除需要删除整个索引

### 创建索引出错

错误原因：执行`PUT /course-publish`

```json
{
  "error" : {
    "root_cause" : [
      {
        "type" : "mapper_parsing_exception",
        "reason" : "Failed to parse mapping [_doc]: analyzer [ik_smart] has not been configured in mappings"
      }
    ],
    "type" : "mapper_parsing_exception",
    "reason" : "Failed to parse mapping [_doc]: analyzer [ik_smart] has not been configured in mappings",
    "caused_by" : {
      "type" : "illegal_argument_exception",
      "reason" : "analyzer [ik_smart] has not been configured in mappings"
    }
  },
  "status" : 400
}
```

原因：[IK分词器没安装](https://blog.csdn.net/sdfadfsdf/article/details/107466784) [[IK分词器地址](https://github.com/medcl/elasticsearch-analysis-ik/releases)]

安装解压在ES的plugins目录下。

### Java实现ES的crud（todo）



